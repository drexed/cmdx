#!/usr/bin/env ruby
# frozen_string_literal: true

# USAGE: RUBY_YJIT_ENABLE=1 bin/profile

begin
  require "ruby-prof"
rescue LoadError
  puts "ruby-prof is not installed, please install it with `gem install ruby-prof`"
  exit 1
end

# rubocop:disable Style/MixinUsage
require_relative "../lib/cmdx"

require_relative "../spec/support/helpers/task_builders"
require_relative "../spec/support/helpers/workflow_builders"
include CMDx::Testing::TaskBuilders
include CMDx::Testing::WorkflowBuilders
# rubocop:enable Style/MixinUsage

CMDx.reset_configuration!
CMDx.configuration.logger = Logger.new(nil)

# While not the best setup for profiling real world usage
# since there is some metaprogramming going on with the task
# creators, its a good baseline to compare against each type
# of halting scenario.
task = create_successful_task

result  = RubyProf::Profile.profile { task.execute }
printer = RubyProf::GraphPrinter.new(result)
printer.print($stdout, min_percent: 1)
